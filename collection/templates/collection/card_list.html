{% extends "base.html" %}

{% block head %} 
    {% load static %} 
{% endblock head %} 

{% block content %}
    {% for set, cards in cards_by_set.items %}
        <p> {{set.name}} {{set.cod}} </p>
        {% for card in cards %}
            <a href = {% url 'collection:card_detail' game_id=set.game_id set_id=set.id card_id=card.id %}> <img src = "{% static card.img_url %}"> </a>
            {% if request.user.is_authenticated %}
                {% if request.session.selection and request.session.listing_id%}
                    {% if request.session.selection_dest == 'for_sale' %}
                        {% if card in listed %}
                            <button class="manageListing" data-action='delete' data-dest='for_sale' data-card-id={{card.id}}>Rimuovi</button>
                        {% else %}
                            <button class="manageListing" data-action='post' data-dest='for_sale' data-card-id={{card.id}}>Seleziona</button>
                        {% endif %}
                    {% elif request.session.selection_dest == 'in_exchange' %}
                        {% if card in listed %}
                            <button class="manageListing" data-action='delete' data-dest='in_exchange' data-card-id={{card.id}}>Rimuovi</button>
                        {% else %}
                            <button class="manageListing" data-action='post' data-dest='in_exchange' data-card-id={{card.id}}>Seleziona</button>
                        {% endif %}
                    {% endif %}
                {% else %}
                    {% if card in owned %}
                        <button class="manageCollection" data-action='remove' data-card-id={{card.id}}>Rimuovi</button>
                    {% else %}
                        <button class="manageCollection" data-action='add' data-card-id={{card.id}}>Aggiungi</button>
                    {% endif %}
                    {% for wishlist in wishlists %}
                        {% if card in wishlist.cards.all %}
                            <button class="manageCollection" data-action='remove' data-wishlist-id={{wishlist.id}} data-card-id={{card.id}}>Rimuovi</button>
                        {% else %}
                            <button class="manageCollection" data-action='add' data-wishlist-id={{wishlist.id}} data-card-id={{card.id}}>Aggiungi</button>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endfor %}
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        $('.manageCollection').click(function(){

            var button = $(this);
            var cardId = button.data('card-id');
            var action = button.data('action');
            var wishlistId = button.data('wishlist-id');
            
            $.ajax({
                url: "{% url 'collection:collection_manage' %}",  // URL dove inviare la richiesta POST
                type: 'POST',
                data: {
                    'action': action,
                    'card_id': cardId,
                    'wishlist_id': wishlistId
                },
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Django richiede il token CSRF per le richieste POST
                },
                success: function(response) {
                    console.log('Success:', response);
                    if(action == 'remove'){
                        button.data('action', 'add');
                        button.text('Aggiungi');
                    }
                    else{
                        button.data('action', 'remove');
                        button.text('Rimuovi');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error:', xhr.responseText);
                }
            });
        });
        
        {% if request.session.selection and request.session.listing_id %}
            $('.manageListing').click(function(){

                var button = $(this);
                var cardId = button.data('card-id');
                var action = button.data('action');
                var dest = button.data('dest');
                
                $.ajax({
                    url: "{% url 'api:listings-detail' pk=request.session.listing_id %}" + "add-remove-cards/",  // URL dove inviare la richiesta POST
                    type: action,
                    data: {
                        'card_id': cardId,
                        'selection_dest': dest
                    },
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'  // Django richiede il token CSRF per le richieste POST
                    },
                    success: function(response) {
                        console.log('Success:', response);
                        if(action == 'delete'){
                            button.data('action', 'post');
                            button.text('Seleziona');
                        }
                        else{
                            button.data('action', 'delete');
                            button.text('Rimuovi');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('Error:', xhr.responseText);
                    }
                });
            });
        {% endif %}
    });
</script>
{% endblock script %}
